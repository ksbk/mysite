{% load static %}
{% load i18n %}
{% load compress %}
{% load core_vite %}
{% load core_site %}

<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:'en' }}"
      dir="{% if LANGUAGE_BIDI %}rtl{% else %}ltr{% endif %}">
  <head>

    {# CORE META TAGS & DOCUMENT SETTINGS #}
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />

    {# SEO & SOCIAL MEDIA META TAGS #}
    {% include "partials/meta/seo.html" %}
    {% include "partials/meta/open_graph.html" %}
    {% include "partials/meta/twitter.html" %}
    {% if SITE.noindex %}<meta name="robots" content="noindex, nofollow" />{% endif %}

    <title>
      {% block title %}{{ SITE.site_name|default:'MySite' }}{% endblock %}
    </title>

    {# PWA & PERFORMANCE OPTIMIZATIONS #}
    {% include "partials/pwa/icons.html" %}
    {% include "partials/performance/resource_hints.html" %}
    <meta name="theme-color"
          content="{{ SITE.theme_color_light|default:'#ffffff' }}"
          media="(prefers-color-scheme: light)" />
    <meta name="theme-color"
          content="{{ SITE.theme_color_dark|default:'#0b0f19' }}"
          media="(prefers-color-scheme: dark)" />


    {# CANONICAL URL & SECURITY TOKENS #}
    <link rel="canonical"
          href="{{ SITE.canonical_url|default:request.build_absolute_uri }}" />
    {% if csrf_token and csrf_token != 'NOTPROVIDED' %}
      <meta name="csrf-token" content="{{ csrf_token }}" />
    {% endif %}

    {# Optional: expose nonce for debugging (not required by browsers) #}
    {% if csp_nonce %}<meta name="csp-nonce" content="{{ csp_nonce }}" />{% endif %}

    {# STRUCTURED DATA & SCHEMA MARKUP #}
    {% block structured_data %}
      {% include "partials/meta/structured_data.html" %}
      {% if SITE.json_ld %}
        {% render_json_ld SITE.json_ld %}
      {% endif %}
    {% endblock %}

    {# ADDITIONAL HEAD CONTENT #}
    {% block head_extra %}{% endblock %}

    {# Vite Assets Integration #}
    {% if VITE_DEV and VITE_DEV_AVAILABLE %}
      {% vite_hmr %}
    {% else %}
      {# Let the vite tag inject the correct hashed CSS & JS #}
      {% vite_asset 'src/main.ts' %}
      {# If your tag supports it, you can optionally preload extracted CSS:
         <link rel="preload" as="style" href="{% vite_css_url 'src/main.ts' %}" onload="this.onload=null;this.rel='stylesheet'" />
         <noscript><link rel="stylesheet" href="{% vite_css_url 'src/main.ts' %}" /></noscript>
      #}
    {% endif %}

    {# CRITICAL CSS (inline or linked) #}
    {% block critical_css %}{% endblock %}
    {# Page-local (non-Vite) CSS, compressed #}
    {% compress css %}
      {% block css %}{% endblock %}
    {% endcompress %}
    {% block extra_css %}{% endblock %}

  </head>
  <body>
    <h1>Hello, World!</h1>
  </body>
</html>
